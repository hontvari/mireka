<!-- 
	SMTP Submission service configuration. This is the service which usually
	runs on port 587.
	
	For more information on the individual configuration elements see the 
	Javadoc documentation in the doc/javadoc directory. For an overview read
	the documentation in the doc directory.  
-->
<web-app xmlns="http://caucho.com/ns/resin"
	xmlns:resin="urn:java:com.caucho.resin"
	xmlns:mireka="urn:java:mireka"
	xmlns:subetha="urn:java:org.subethamail.smtp.server"
	xmlns:subethaauth="urn:java:org.subethamail.smtp.auth"
	xmlns:concurrent="urn:java:java.util.concurrent"
	xmlns:ee="urn:java:ee"
	>
	
	<!-- 
		Comment out if mails will be relayed through the backend server.
		In that case queues are not necessary. 
	-->
	<resin:import path="${__DIR__}/queues.xml" />
	
	<!--
		This table assigns a destination to any recipient addresses.
	-->
	<mireka:RecipientTable>
		<Named>submissionRecipientTable</Named>

		<!--
			Local recipients will be delivered according to their
			destination as specified in localRecipientsTable.
		-->
		<mireka:mapper>
			#{localRecipientsTable}
		</mireka:mapper>
		
		<!--
			Any other recipients will be either transmitter directly 
			to the remote domain or relayed to the backend server.
		-->
		<mireka:mapper>
			<mireka:RecipientSpecificationDestinationPair>
				<mireka:recipientSpecification>
					<mireka:AnyRecipient />
				</mireka:recipientSpecification>
				<mireka:destination>
					<!-- 
						comment out if all mails will be 
						relayed through the backend 
						server
					-->
					<mireka:TransmitterDestination>
						<mireka:transmitter>
							#{primaryTransmitter}
						</mireka:transmitter>
					</mireka:TransmitterDestination>
					
					<!-- 
						uncomment to relay all mail to 
						the backend server 
					-->
					<!--
					<mireka:RelayDestination>
						<mireka:backendServer>
							#{backendServer}
						</mireka:backendServer>
					</mireka:RelayDestination>
					-->
				</mireka:destination>
				
			</mireka:RecipientSpecificationDestinationPair>
		</mireka:mapper>
	</mireka:RecipientTable>

	<resource name="submissionTrafficSummary" 
			mbean-name="mireka:type=TrafficSummary,name=Submission"
			type="mireka.filter.misc.TrafficSummary" />
			
	<!--
		The filter chain.
		
		It is unlikely that you need to change this, except if you use
		a custom filter.
	-->
	<mireka:Filters>
		<Named>submissionFilters</Named>
		
		<mireka:filter>
			<mireka:MeasureTraffic>
				<mireka:trafficSummary>
					#{submissionTrafficSummary}
				</mireka:trafficSummary>
			</mireka:MeasureTraffic>
		</mireka:filter>
		<mireka:filter>
			<mireka:RejectIfUnauthenticated>
				<mireka:authenticatedSpecification>
					<mireka:SmtpAuthenticated/>
				</mireka:authenticatedSpecification>
				<mireka:authenticatedSpecification>
					<mireka:ConnectedFromAuthorizedIpAddress>
						<resin:import path="${__DIR__}/authorized-ip.xml" />
					</mireka:ConnectedFromAuthorizedIpAddress>
				</mireka:authenticatedSpecification>
			</mireka:RejectIfUnauthenticated>
		</mireka:filter>
		<mireka:filter>
			<mireka:LookupDestinationFilter>
				<mireka:recipientDestinationMapper>
					#{submissionRecipientTable}
				</mireka:recipientDestinationMapper>
			</mireka:LookupDestinationFilter>
		</mireka:filter>
		<mireka:filter>
			<mireka:RejectLargeMail/>
		</mireka:filter>
		<mireka:filter>
			<mireka:AcceptGlobalPostmaster/>
		</mireka:filter>
		<mireka:filter>
			<mireka:AcceptDomainPostmaster/>
		</mireka:filter>
		<mireka:filter>
			<mireka:AcceptAllRecipient />
		</mireka:filter>
		<mireka:filter>
			<mireka:SavePostmasterMail>
				<mireka:dir>${mirekaHome}/postmaster</mireka:dir>
			</mireka:SavePostmasterMail>
		</mireka:filter>
		<mireka:filter>
			<mireka:StopLoop />
		</mireka:filter>
		<mireka:filter>
			<mireka:DestinationProcessorFilter />
		</mireka:filter>
	</mireka:Filters>
	
	<!--
		Authentication
	-->
	<mireka:UsernamePasswordValidatorImpl>
		<Named>usernamePasswordValidator</Named>
		
		<mireka:loginSpecification>
			<mireka:GlobalUsersLoginSpecification>
				<mireka:users>#{globalUsers}</mireka:users>
			</mireka:GlobalUsersLoginSpecification>
		</mireka:loginSpecification>
	</mireka:UsernamePasswordValidatorImpl>

	<!-- Do not change this -->
	<mireka:MessageHandlerFactoryImpl>
		<Named>submissionMessageHandler</Named>
		<mireka:filters>#{submissionFilters}</mireka:filters>
	</mireka:MessageHandlerFactoryImpl>

	<subethaauth:EasyAuthenticationHandlerFactory>
		<Named>authenticationHandlerFactory</Named>
		<new>#{usernamePasswordValidator}</new>
	</subethaauth:EasyAuthenticationHandlerFactory>
	
	<!--
		Configure server name, bind address, etc. here.
	-->
	<mireka:SMTPServer>
		<Named>submission</Named>
		<ee:Startup/>
		<new>
			#{submissionMessageHandler}
		</new>
		<mireka:authenticationHandlerFactory>
			#{authenticationHandlerFactory}
		</mireka:authenticationHandlerFactory>
		<!-- <mireka:bindAddress>192.0.2.0</mireka:bindAddress> -->
		<mireka:port>587</mireka:port>
		<mireka:hostName>${helo}</mireka:hostName>
		<!-- uncomment to enable STARTTLS if JSSE is correctly configured -->
		<!-- <mireka:enableTLS>true</mireka:enableTLS> -->
	</mireka:SMTPServer>
	
</web-app>