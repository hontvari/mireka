<!-- 
	Configuration of the persistent mail queues used by the SMTP Mail 
	Submission service.
	
	For more information on the individual configuration elements see the 
	Javadoc documentation in the doc/javadoc directory. For an overview read
	the documentation in the doc directory.  
-->
<web-app xmlns="http://caucho.com/ns/resin"
	xmlns:resin="urn:java:com.caucho.resin"
	xmlns:mireka="urn:java:mireka"
	xmlns:subetha="urn:java:org.subethamail.smtp.server"
	xmlns:subethaauth="urn:java:org.subethamail.smtp.auth"
	xmlns:concurrent="urn:java:java.util.concurrent"
	xmlns:ee="urn:java:ee"
	>

	<!--
		Mail address used in the From header of Message Delivery 
		Notification messages, sent by Mireka to notify the sender about
		a failed delivery.
	-->
	<mireka:NameAddr>
		<Named>mailerdaemon</Named>
		<new>
			<value>Mail Delivery Subsystem</value>
			<value>mailer-daemon@example.com</value>
		</new>
	</mireka:NameAddr>
	
	<mireka:ScheduleFileDirQueue>
		<Named>submittedMailQueue</Named>
		<ApplicationScoped/>
		<ee:Startup/>
		<mireka:store>
			<mireka:FileDirStore>
				<dir>${mirekaHome}/queues/submitted</dir>
			</mireka:FileDirStore>
		</mireka:store>
		<mireka:mailProcessorFactory>
			#{primaryTransmitter}
		</mireka:mailProcessorFactory>
		<mireka:executor>
				<concurrent:ScheduledThreadPoolExecutor>
					<new><value>10</value></new>
				</concurrent:ScheduledThreadPoolExecutor>
		</mireka:executor>
	</mireka:ScheduleFileDirQueue>

	<mireka:ScheduleFileDirQueue>
		<Named>retryMailQueue</Named>
		<ApplicationScoped/>
		<ee:Startup/>
		<mireka:store>
			<mireka:FileDirStore>
				<dir>${mirekaHome}/queues/retry</dir>
			</mireka:FileDirStore>
		</mireka:store>
		<mireka:mailProcessorFactory>
			#{retryTransmitter}
		</mireka:mailProcessorFactory>
		<mireka:executor>
				<concurrent:ScheduledThreadPoolExecutor>
					<new><value>5</value></new>
				</concurrent:ScheduledThreadPoolExecutor>
		</mireka:executor>
	</mireka:ScheduleFileDirQueue>
	
	<mireka:ScheduleFileDirQueue>
		<Named>dsnMailQueue</Named>
		<ApplicationScoped/>
		<ee:Startup/>
		<mireka:store>
			<mireka:FileDirStore>
				<dir>${mirekaHome}/queues/dsn</dir>
			</mireka:FileDirStore>
		</mireka:store>
		<mireka:mailProcessorFactory>
			#{dsnTransmitter}
		</mireka:mailProcessorFactory>
		<mireka:executor>
				<concurrent:ScheduledThreadPoolExecutor>
					<new><value>5</value></new>
				</concurrent:ScheduledThreadPoolExecutor>
		</mireka:executor>
	</mireka:ScheduleFileDirQueue>

	<mireka:LogIdFactory>
		<Named>logIdFactory</Named>
		<ApplicationScoped/>
	</mireka:LogIdFactory>
	
	<mireka:OutgoingConnectionsRegistry>
		<Named>outgoingConnectionRegisty</Named>
		<ApplicationScoped/>
		<!-- 
			uncomment to switch off limiting simultaneous connections 
			to a single host
		-->
		<!--
		<maxConnectionsToHost>0</maxConnectionsToHost>
		-->		
	</mireka:OutgoingConnectionsRegistry>

	<mireka:MailToHostTransmitterFactory>
		<Named>mailToHostTransmitterFactory</Named>
		<mireka:clientFactory>
			#{clientFactory}
		</mireka:clientFactory>
		<mireka:outgoingConnectionRegistry>
			#{outgoingConnectionRegisty}
		</mireka:outgoingConnectionRegistry>
		<mireka:logIdFactory>
			#{logIdFactory}
		</mireka:logIdFactory>
	</mireka:MailToHostTransmitterFactory>
	
	<mireka:ImmediateSenderFactory>
		<Named>immediateSenderFactory</Named>
		<mireka:mailToHostTransmitterFactory>
			#{mailToHostTransmitterFactory}
		</mireka:mailToHostTransmitterFactory>
	</mireka:ImmediateSenderFactory>

	<mireka:DsnMailCreator>
		<Named>dsnMailCreator</Named>
		<new>
			<value>${helo}</value> <!-- reportingMtaName -->
			<value>${mailerdaemon}</value><!-- fromAddress -->
		</new>
	</mireka:DsnMailCreator>
	
	<mireka:RetryPolicy>
		<Named>retryPolicy</Named>
		<mireka:dsnMailCreator>
			#{dsnMailCreator}
		</mireka:dsnMailCreator>
		<mireka:dsnTransmitter>
			#{dsnTransmitter}
		</mireka:dsnTransmitter>
		<mireka:retryTransmitter>
			#{retryTransmitter}
		</mireka:retryTransmitter>
	</mireka:RetryPolicy>
	
	<resource name="submissionTransmitterSummary"
			type="mireka.transmission.queue.TransmitterSummary"
			mbean-name="mireka:type=TransmitterTraffic,name=submission" />

	<mireka:QueuingTransmitter>
		<Named>primaryTransmitter</Named>
		<ApplicationScoped/>
		<mireka:queue>
			#{submittedMailQueue}
		</mireka:queue>
		<mireka:immediateSenderFactory>
			#{immediateSenderFactory}
		</mireka:immediateSenderFactory>
		<mireka:retryPolicy>
			#{retryPolicy}
		</mireka:retryPolicy>
		<mireka:logIdFactory>
			#{logIdFactory}
		</mireka:logIdFactory>
		<mireka:summary>#{submissionTransmitterSummary}</mireka:summary>
	</mireka:QueuingTransmitter>
	
	<resource name="dsnTransmitterSummary"
			type="mireka.transmission.queue.TransmitterSummary"
			mbean-name="mireka:type=TransmitterTraffic,name=dsn" />

	<mireka:QueuingTransmitter>
		<Named>dsnTransmitter</Named>
		<ApplicationScoped/>
		<mireka:queue>
			#{dsnMailQueue}
		</mireka:queue>
		<mireka:immediateSenderFactory>
			#{immediateSenderFactory}
		</mireka:immediateSenderFactory>
		<mireka:retryPolicy>
			#{retryPolicy}
		</mireka:retryPolicy>
		<mireka:logIdFactory>
			#{logIdFactory}
		</mireka:logIdFactory>
		<mireka:summary>#{dsnTransmitterSummary}</mireka:summary>
	</mireka:QueuingTransmitter>
	
	<resource name="retryTransmitterSummary"
			type="mireka.transmission.queue.TransmitterSummary"
			mbean-name="mireka:type=TransmitterTraffic,name=retry" />

	<mireka:QueuingTransmitter>
		<Named>retryTransmitter</Named>
		<ApplicationScoped/>
		<mireka:queue>
			#{retryMailQueue}
		</mireka:queue>
		<mireka:immediateSenderFactory>
			#{immediateSenderFactory}
		</mireka:immediateSenderFactory>
		<mireka:retryPolicy>
			#{retryPolicy}
		</mireka:retryPolicy>
		<mireka:logIdFactory>
			#{logIdFactory}
		</mireka:logIdFactory>
		<mireka:summary>#{retryTransmitterSummary}</mireka:summary>
	</mireka:QueuingTransmitter>
	
</web-app>